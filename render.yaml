# Render Deployment Configuration
# https://render.com/docs/blueprint-spec

services:
  # FastAPI Web Service
  - type: web
    name: plant-disease-detection-api
    env: python
    region: oregon
    plan: free
    branch: main
    buildCommand: pip install -r requirements.txt
    startCommand: uvicorn app.main:app --host 0.0.0.0 --port $PORT --workers 1 --timeout-keep-alive 30
    
    # Environment Variables
    envVars:
      - key: PYTHON_VERSION
        value: 3.12.0
      
      - key: APP_NAME
        value: Plant Disease Detection API
      
      - key: APP_VERSION
        value: 2.0.0
      
      - key: DEBUG
        value: false
      
      - key: SECRET_KEY
        generateValue: true
        # Or set manually in Render dashboard
      
      - key: HOST
        value: 0.0.0.0
      
      - key: PORT
        value: 8000
      
      - key: MAX_FILE_SIZE
        value: 16777216
      
      - key: ALLOWED_EXTENSIONS
        value: png,jpg,jpeg
      
      - key: SESSION_MAX_AGE
        value: 86400
      
      - key: IMG_HEIGHT
        value: 224
      
      - key: IMG_WIDTH
        value: 224
      
      # TensorFlow optimization
      - key: TF_ENABLE_ONEDNN_OPTS
        value: 0
      
      - key: TF_CPP_MIN_LOG_LEVEL
        value: 2
    
    # Health check endpoint
    healthCheckPath: /api/health
    
    # Auto-deploy on push
    autoDeploy: true
    
    # Instance settings
    numInstances: 1
    
    # Disk for uploaded images (persistent storage)
    disk:
      name: uploads
      mountPath: /opt/render/project/src/static/uploads
      sizeGB: 1

# Optional: Database (uncomment if needed)
# databases:
#   - name: plant-disease-db
#     databaseName: plant_disease
#     plan: free
#     region: oregon

# Optional: Redis (uncomment if needed for sessions)
# - type: redis
#   name: plant-disease-redis
#   plan: free
#   region: oregon
#   maxmemoryPolicy: allkeys-lru
